<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Broadcaster Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
      min-height: 100vh;
      color: #fff;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 32px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .subtitle {
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 40px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .stat-value {
      font-size: 42px;
      font-weight: 700;
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .stat-label {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 5px;
    }
    
    .section {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      margin-bottom: 20px;
    }
    
    .section h2 {
      font-size: 18px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .device-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .device-item {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .device-item:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    
    .device-item.active {
      border-color: #00d2ff;
      background: rgba(0, 210, 255, 0.1);
    }
    
    .device-name {
      font-weight: 500;
    }
    
    .device-index {
      color: rgba(255, 255, 255, 0.4);
      font-size: 13px;
    }
    
    .share-url {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .share-url input {
      flex: 1;
      background: none;
      border: none;
      color: #00d2ff;
      font-family: monospace;
      font-size: 14px;
      outline: none;
    }
    
    .copy-btn {
      background: rgba(0, 210, 255, 0.2);
      border: none;
      color: #00d2ff;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .copy-btn:hover {
      background: rgba(0, 210, 255, 0.3);
    }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0, 255, 136, 0.2);
      border-radius: 20px;
      font-size: 13px;
      color: #00ff88;
    }
    
    .status-badge.offline {
      background: rgba(255, 107, 107, 0.2);
      color: #ff6b6b;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .instructions {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 20px;
    }
    
    .instructions h3 {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 10px;
    }
    
    .instructions code {
      display: block;
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 8px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      color: #00d2ff;
      margin-top: 10px;
      overflow-x: auto;
    }
    
    .refresh-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì° Broadcaster Dashboard</h1>
    <p class="subtitle">Manage your audio broadcast</p>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="listeners">0</div>
        <div class="stat-label">Active Listeners</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="uptime">0:00</div>
        <div class="stat-label">Uptime</div>
      </div>
      <div class="stat-card">
        <div>
          <span class="status-badge" id="statusBadge">
            <span class="status-dot"></span>
            <span id="statusText">Checking...</span>
          </span>
        </div>
        <div class="stat-label" style="margin-top: 15px;">Stream Status</div>
      </div>
    </div>
    
    <div class="section">
      <h2>üé§ Audio Input Device</h2>
      <div class="device-list" id="deviceList">
        <p style="color: rgba(255,255,255,0.5)">Loading devices...</p>
      </div>
    </div>
    
    <div class="section">
      <h2>üîó Share Link</h2>
      <p style="color: rgba(255,255,255,0.6); margin-bottom: 15px; font-size: 14px;">
        Share this URL with listeners:
      </p>
      <div class="share-url">
        <input type="text" id="shareUrl" readonly>
        <button class="copy-btn" onclick="copyUrl()">Copy</button>
      </div>
    </div>
    
    <div class="section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">‚öôÔ∏è Quick Start</h2>
        <button class="refresh-btn" onclick="loadStatus()">‚Üª Refresh</button>
      </div>
      <div class="instructions">
        <h3>To change audio device via command line:</h3>
        <code>AUDIO_DEVICE=1 npm start</code>
        
        <h3 style="margin-top: 20px;">Make sure ffmpeg is installed:</h3>
        <code>brew install ffmpeg</code>
      </div>
    </div>
  </div>

  <script>
    const listenersEl = document.getElementById('listeners');
    const uptimeEl = document.getElementById('uptime');
    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    const deviceList = document.getElementById('deviceList');
    const shareUrl = document.getElementById('shareUrl');
    
    // Set share URL
    shareUrl.value = window.location.origin;
    
    function formatUptime(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      
      if (h > 0) {
        return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
      }
      return `${m}:${s.toString().padStart(2, '0')}`;
    }
    
    async function loadStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        
        listenersEl.textContent = data.listeners;
        uptimeEl.textContent = formatUptime(data.uptime);
        
        if (data.streaming) {
          statusBadge.classList.remove('offline');
          statusText.textContent = 'Streaming';
        } else if (data.listeners > 0) {
          statusBadge.classList.remove('offline');
          statusText.textContent = 'Ready';
        } else {
          statusBadge.classList.add('offline');
          statusText.textContent = 'Waiting';
        }
      } catch (e) {
        statusBadge.classList.add('offline');
        statusText.textContent = 'Offline';
      }
    }
    
    async function loadDevices() {
      try {
        const [devicesRes, statusRes] = await Promise.all([
          fetch('/api/devices'),
          fetch('/api/status')
        ]);
        
        const devices = await devicesRes.json();
        const status = await statusRes.json();
        const currentDevice = status.audioDevice || '0';
        
        if (devices.length === 0) {
          deviceList.innerHTML = '<p style="color: rgba(255,255,255,0.5)">No audio devices found. Make sure ffmpeg is installed.</p>';
          return;
        }
        
        deviceList.innerHTML = devices.map(device => `
          <div class="device-item ${device.index === currentDevice ? 'active' : ''}" 
               onclick="selectDevice('${device.index}')">
            <div>
              <div class="device-name">${device.name}</div>
              <div class="device-index">Device ${device.index}</div>
            </div>
            ${device.index === currentDevice ? '<span style="color: #00d2ff">‚úì Active</span>' : ''}
          </div>
        `).join('');
      } catch (e) {
        deviceList.innerHTML = '<p style="color: rgba(255,255,255,0.5)">Failed to load devices</p>';
      }
    }
    
    async function selectDevice(index) {
      try {
        await fetch(`/api/device/${index}`, { method: 'POST' });
        loadDevices();
      } catch (e) {
        console.error('Failed to select device:', e);
      }
    }
    
    function copyUrl() {
      shareUrl.select();
      document.execCommand('copy');
      
      const btn = document.querySelector('.copy-btn');
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 2000);
    }
    
    // Initial load
    loadStatus();
    loadDevices();
    
    // Poll for updates
    setInterval(loadStatus, 2000);
  </script>
</body>
</html>
